- [0. Linguaggi dei DBMS](#0-linguaggi-dei-dbms)
  - [0.1 SQL](#01-sql)
- [1. Definizione Struttura Dati](#1-definizione-struttura-dati)
  - [1.1 Create Database](#11-create-database)
  - [1.2 Drop Database](#12-drop-database)
  - [1.3 Create Table](#13-create-table)
    - [1.3.1 Domini](#131-domini)
    - [1.3.2 Creazione delle tabelle](#132-creazione-delle-tabelle)
  - [1.4 Drop Table](#14-drop-table)
  - [1.5 Alter Table](#15-alter-table)
- [2. Interrogazioni di una Tabella](#2-interrogazioni-di-una-tabella)
  - [2.1 SELECT](#21-select)
    - [2.1.2 Where](#212-where)
    - [2.1.3 From](#213-from)
    - [2.1.4 Group By](#214-group-by)
    - [2.1.5 Having](#215-having)
    - [2.1.6 Order By](#216-order-by)
  - [2.2 Operazioni Insiemistiche](#22-operazioni-insiemistiche)
  - [2.3 Join](#23-join)
    - [2.3.1 Join Esterno](#231-join-esterno)
  - [2.4 Select Annidati](#24-select-annidati)
  - [2.5 Viste](#25-viste)
- [3. Inserimento, Aggiornamento e Rimozione di Righe](#3-inserimento-aggiornamento-e-rimozione-di-righe)
  - [3.1 Inserimento](#31-inserimento)
  - [3.2 Aggiornamento](#32-aggiornamento)
  - [3.3 Rimozione](#33-rimozione)

# 0. Linguaggi dei DBMS

Un DBMS fornisce diversi linguaggi per implementare una base di dati:

-   _Data Definition Language_ (DDL): un linguaggio usato per specificare lo schema concettuale, descrivere le entità, associazioni e i loro vincoli.
-   _Storage Definition Language_ (SDL): consente di descrivere la struttura di memorizzazione fisica dei dati.
-   _View Definition Language_ (VDL): usato per specificare viste, permettono di visualizzare i dati in un modo più comodo per l'utente.
-   _Data Manipulation Language_ (DML): Utilizzato per la manipolazione dei dati, inserimento, cancellazione, modifica.

## 0.1 SQL

Acronimo per _Standard Query Language_ è un linguaggio che permette di specificare uno schema concettuale e permette di inserire, modificare, cancellare e reperire i dati.
SQL in particolare è un DDL e un DML, vedremo anche qualche accenno dell'implementazione del VDL.

# 1. Definizione Struttura Dati

Le istruzioni SQL che vedremo in questo capitolo sono:

| Istruzione      | Descrizione                                    |
| --------------- | ---------------------------------------------- |
| CREATE DATABASE | creazione dello schema di una base di dati     |
| DROP DATABASE   | cancellazione dello schema di una base di dati |
| CREATE TABLE    | creazione dello schema di una tabella          |
| DROP TABLE      | cancellazione dello schema di una tabella      |
| ALTER TABLE     | modifica dello schema di una tabella           |

## 1.1 Create Database

Crea un database, ovvero una raccolta di tabelle che descrive un mini-mondo.
`CREATE DATABASE concerto`
`CREATE DATABASE "Concerto"`
#oss le virgolette ci permettono di specificare nomi case-sensitive

## 1.2 Drop Database

In modo totalmente simile a `CREATE DATABASE` permette di eliminare un database.
`DROP DATABASE concerto`
`DROP DATABASE "Concerto"`

## 1.3 Create Table

### 1.3.1 Domini

#### <span style="color:#efb458">Stringhe</span>

**CHARACTER:** può contenere un singolo carattere (es. 'A', 'B')
**CHARACTER(length):** può contenere una stringa di lunghezza costante > 1. (es. 'Hello', 'World')
**VARCHAR:** stringa di lunghezza variabile.

#### <span style="color:#efb458">Tipi Numerici Esatti:</span>

**DECIMAL:** Reali esatti sui quali si può specificare una precisione (numero cifre parte intera) ed una scala (numero cifre parte frazionaria).
**INTEGER:** Interi esatti
**SMALLINT:** Interi esatti piccoli
**BOOLEAN:** `true` o `false`

#### <span style="color:#efb458">Tipi Numerici Approssimati:</span>

**FLOAT:** Floating point
(Attenzione alla comparazione tra numeri in floating point)

#### <span style="color:#efb458">Tempo</span>

**DATE:** memorizza una data, possiede i campi YEAR, MONTH e DAY
**TIME:** memorizza un orario, possiede i campi HOUR, MINUTE, SECOND
**TIMESTAMP:** memorizza un datetime, possiede i campi di DATE e di TIME
**INTERVAL:** una quantità ed un'unità di misura (year, month, day, ...). Si possono anche combinare con (`year to month`, con month opzionale)

#### <span style="color:#efb458">Altri Domini</span>

**Interi Autoincrementanti:** `id INTEGER GENERATED BY DEFAULT AS IDENTITY`

#### <span style="color:#efb458">Domini Custom</span>

Possiamo anche definire i domini in modo custom così da limitare i valori assegnabili ad una colonna.
Per fare ciò si utilizza la sintassi `CREATE DOMAIN NomeDominio AS TipoDiDato [ValoreDiDefault] [Vincolo]`

#es `CREATE DOMAIN Voto AS SMALLINT DEFAULT IS 18 CHECK (VALUE >= 18 AND VALUE <= 30)`

### 1.3.2 Creazione delle tabelle

Una tabella SQL è costituita da una collezione ordinata di attributi e un insieme di vincoli.

#es

```
CREATE TABLE Dipartimento
{
	Nome         VARCHAR(20) PRIMARY KEY
	Indirizzo    VARCHAR(50)
	Città        VARCHAR(20) DEFAULT "Padova"
}
```

#### <span style="color:#efb458">Attributi Opzionali</span>

Gli attributi opzionali vengono indicati con un `*` e si possono definire in questo modo se il valore può non esistere (il caso in cui non è noto esula dal corso).

#### <span style="color:#efb458">Chiave Primaria</span>

La chiave primaria viene specificata tramite le keyword `PRIMARY KEY`, mentre le chiavi candidate sono rappresentate tramite la keyword `UNIQUE`

Entrambe possono essere utilizzate su più attributi
`PRIMARY KEY (Nome, Indirizzo)`
#es
Per rappresentare la chiave primaria la si sottolinea e si evidenziano anche le chiavi candidate

<code>DIPARTIMENTO(<span style="text-decoration:underline">Nome</span>, Indirizzo, Città)
<br>&nbsp;&nbsp;&nbsp;&nbsp;<span>CC: {Indirizzo, Città}</span></code>

#### <span style="color:#efb458">NOT NULL</span>

Si può aggiungere ad ogni attributo un vincolo di esistenza, `NOT NULL`

#### <span style="color:#efb458">Integrità Referenziale</span>

Se in una tabella abbiamo un attributo che riporta una chiave di un'altra tabella esso viene detto **chiave esterna**, quindi la chiave che specifichiamo nella tabella deve esistere nella tabella esterna.

#es
Per rappresentare l'integrità referenziale si usa una sottolineatura ondulata sotto ogni chiave esterna.
<code>DIPARTIMENTO(<span style="text-decoration:underline">Nome</span>, Indirizzo, <span style="text-decoration:wavy underline">Città</span>)
<br>&nbsp;&nbsp;&nbsp;&nbsp;<span>CC: {Indirizzo, Città}</span>
<br>&nbsp;&nbsp;&nbsp;&nbsp;<span>IR: Città -> CITTÀ.Nome</span></code>

#oss L'integrità referenziale si può usare anche su due o più attributi definendo così un tupla di attributi che si devono trovare nella tabella di reference.

#es

```
CREATE TABLE Dipartimento
{
	//Chiave Singola
	Nome         VARCHAR(20) PRIMARY KEY

	//Chiave Multipla
	Nome         VARCHAR(20)
	Soprannome   VARCHAR(20)
	PRIMARY KEY (Nome, Soprannome)
}
{
	// Chiave Candidata
	Indirizzo    VARCHAR(50) UNIQUE

	// Chiave Multipla Candidata
	Indirizzo    VARCHAR(50)
	Soprannome   VARCHAR(20)
	UNIQUE (Indirizzo, Soprannome)
}
{
	// Integrità Referenziale
	Città        VARCHAR(20) REFERENCES CITTA(Nome)

	// Integrità Referenziale Multipla
	Città        VARCHAR(20)
	Popolazione  VARCHAR(20)
	FOREIGN KEY (Città, Popolazione) REFERENCES TABLE_PRINCI(Città, Popolazione)
}
```

##### Aggiornamento di una Riga

L'aggiornamento di un elemento che viene referenziato in un'altra tabella richiede la specifica di una politica di rimpiazzo

| Politica      | Modifica effettuata al database referenziante                                        | Note                                                         |
| ------------- | ------------------------------------------------------------------------------------ | ------------------------------------------------------------ |
| `CASCADE`     | Viene aggiornato a cascata anche sui database referenzianti                          |                                                              |
| `SET NULL`    | Viene impostato a `NULL`                                                             | L'attributo nel database referenziante deve essere opzionale |
| `SET DEFAULT` | Viene impostato al valore di default                                                 |                                                              |
| `NO ACTION`   | Finché non vengono rimosse tutte le reference non è possibile modificare l'elemento. | È la politica di default                                     |

##### Eliminazione di una Riga

Similmente a quanto visto sopra è importante specificare una politica di rimpiazzo per l'eliminazione di un elemento che viene referenziato da altre tabelle.

Le politiche si comportano in modo uguale tranne per `CASCADE` che elimina a cascata anche tutti gli elementi che referenziano la tabella.

#es `id INTEGER REFERENCES ALBUM(IdeAlbum) ON DELETE CASCADE ON UPDATE CASCADE`

## 1.4 Drop Table

Similmente a `DROP DATABASE` permette di eliminare una tabella.

## 1.5 Alter Table

L'operazione Alter Table consente di modificare una tabella, in particolare di aggiungere o rimuovere attributi:
`ALTER TABLE Dipartimento ADD DataFondazione DATE`
`ALTER TABLE Dipartimento DROP DataFondazione`

# 2. Interrogazioni di una Tabella

In SQL le interrogazioni si fanno mediante il comando `SELECT` seguito dalla query.

```sql
SELECT <lista di attributi>
FROM <lista di tabelle>
WHERE <condizione di selezione>
GROUP BY <lista di attributi (di raggruppamento)>
HAVING <condizione (di raggruppamento)>
ORDER BY <lista di attributi>
```

#oss solo le prime due keyword sono obbligatorie, `SELECT` e `FROM`

## 2.1 SELECT

1. Seguito da un attributo
   `SELECT Nome FROM Utenti`
2. Seguito da due o più attributi
   `SELECT Nome, Indirizzo FROM Utenti`
3. Seguito da _
   `SELECT _ FROM Utenti`
4. Ridenominazione
   `SELECT Nome AS "Username" FROM Utenti`
5. Espressione
   `SELECT Id, Stipendio/12 AS "StipendioMensile" FROM Impiegati`

#oss è possibile usare la keyword `DISTINCT` per selezionare solo le righe uniche

### 2.1.2 Where

La clausola `WHERE` deve essere seguita da un'espressione booleana
Si possono usare i seguenti operatori di confronto:

1. `>`, `<`
2. `>=`, `<=`
3. `<>` (Ovvero !=)
4. `=`
5. `LIKE` definito solo per le stringhe (Ha una sintassi di pattern custom)
6. `AND`, `OR`, `NOT`

### 2.1.3 From

La tabella o le tabelle dove va eseguita l'operazione

#es `FROM Aereoporti SELECT * WHERE id='NL'`

### 2.1.4 Group By

Possiamo utilizzare Group By per raggruppare le righe che hanno gli stessi valori su una colonna.
Spesso utilizzato con le operazioni di Aggregazione

#es "Conta quanti Customer ci sono per ogni paese"
`SELECT COUNT(CustomerID), Country FROM Customers GROUP BY Country;`

### 2.1.5 Having

È del tutto simile alla clausola `WHERE`, ma viene utilizzato per le funzioni di aggregazione.

### 2.1.6 Order By

Permette di ritornare i valori seguendo uno specifico ordine, è necessario porre attenzione perché aumenta il tempo di esecuzione.

| Posizione sintattica | Ordine di elaborazione | Clausola |
| -------------------- | ---------------------- | -------- |
| 1                    | 5                      | SELECT   |
| 2                    | 1                      | FROM     |
| 3                    | 2                      | WHERE    |
| 4                    | 3                      | GROUP BY |
| 5                    | 4                      | HAVING   |
| 6                    | 6                      | ORDER BY |

## 2.2 Operazioni Insiemistiche

```
SELECT id FROM Merchant1
UNION
SELECT id FROM Merchant2
```

[come non utilizzare questa funzione](https://youtu.be/uPrXEtvKFoI)

In alcune versioni di sql esistono anche le operazioni di `EXCEPT` e `INTERSECT`, ma esse possono essere sostituite da dei select annidati.

## 2.3 Join

Utilizzato per unire due o più tabelle in base ad una colonna comune tra loro

#es `SELECT ST.* FROM SCUOLE AS SC JOIN STUDENTI AS ST ON SC.NomeCitta <> ST.NomeCittaResi AND SC.IdeScuola = ST.IdeScuola;`

### 2.3.1 Join Esterno

Per effettuare il join esterno destro e sinistro la sintassi è `RIGHT JOIN` e `LEFT JOIN`
Il join esterno completo è l'unione del join destro e il join sinistro.

## 2.4 Select Annidati

Ogni query può avere:

-   1 select
-   2 o più select
    -   se sono allo stesso livello SQL risolve le due query separatamente e poi le unisce come specificato (`UNION`, `INTERSECT`, ...)
    -   I select sono **annidati**
        -   Il select interno è indipendente da quello esterno, allora SQL lo esegue solo una volta, all'inizio.
        -   Il select interno è collegato a quello esterno. SQL lo esegue per ogni riga del select esterno

## 2.5 Viste

Le viste sono delle tabelle che contengono alcuni dei dati contenuti in una tabella "normale" e altri dati direttamente ricavabili da quelli contenuti nella tabella "normale".

Le Viste di default rimangono salvate nel database finché non vengono manualmente rimosse tramite `DROP NomeVista`.
Oppure possono essere temporanee e venir eliminate quando chiudiamo la sessione di accesso al db.

```sql
CREATE VIEW NomeVista(Matricola, Nome, Cognome, Stipendio) AS
SELECT Matricola, Nome, Cognome, Stipendio
FROM Impiegato
WHERE Dipart = 'Amministrazione' AND Stipendio > 10
```

# 3. Inserimento, Aggiornamento e Rimozione di Righe

## 3.1 Inserimento

Si utilizza l'istruzione `INSERT INTO`
#es

```sql
INSERT INTO studenti(Matricola, Nome, Cognome)
VALUES
(2066520, Giorgio, Rossi),
(2066521, Matteo, Bianchi)
```

## 3.2 Aggiornamento

Si utilizza l'istruzione `UPDATE`
#es

```sql
UPDATE studenti
SET Nome = "Alessandro"
WHERE Matricola = 2066521
```

## 3.3 Rimozione

Si utilizza l'istruzione `DELETE FROM`
#es

```sql
DELETE FROM studenti
WHERE Matricola = 2066521
```
